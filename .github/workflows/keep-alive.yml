# GitHub Actions Workflow: Keep Backend Alive
#
# Purpose: Prevents Render.com free tier from sleeping by pinging health endpoint
#
# How it works:
# - Runs every 10 minutes (GitHub Actions allows 5-minute intervals minimum)
# - Makes HTTP request to backend health endpoint
# - Keeps Render service warm (avoids 30s cold start)
#
# Cost: FREE (GitHub Actions provides 2000 minutes/month for free)
#
# Note: This is OPTIONAL. Your deployment works fine without it, but users
#       will experience a 30-second delay on first request after 15 min of inactivity.
#
# To disable: Delete this file or disable the workflow in GitHub Actions settings

name: Keep Render Backend Alive

on:
  schedule:
    # Run every 10 minutes
    # Syntax: minute hour day month day-of-week
    # */10 = every 10 minutes
    - cron: '*/10 * * * *'

  # Allow manual trigger from Actions tab
  workflow_dispatch:

jobs:
  ping-health:
    runs-on: ubuntu-latest

    steps:
      - name: Ping backend health endpoint
        run: |
          echo "Pinging Canopy Intelligence backend..."
          echo "Endpoint: https://canopy-intelligence-api.onrender.com/health"

          # Make HTTP request to health endpoint
          response=$(curl -s -o /dev/null -w "%{http_code}" https://canopy-intelligence-api.onrender.com/health)

          # Check if request was successful
          if [ "$response" -eq 200 ]; then
            echo "✅ Backend is healthy (HTTP $response)"
            echo "Service is awake and ready to serve requests"
          else
            echo "⚠️ Backend returned HTTP $response"
            echo "This might indicate the service is waking up or experiencing issues"
          fi

      - name: Check Neo4j connectivity
        run: |
          echo "Checking Neo4j database connectivity..."
          echo "Endpoint: https://canopy-intelligence-api.onrender.com/health/neo4j"

          response=$(curl -s -o /dev/null -w "%{http_code}" https://canopy-intelligence-api.onrender.com/health/neo4j)

          if [ "$response" -eq 200 ]; then
            echo "✅ Neo4j connection is healthy (HTTP $response)"
          else
            echo "⚠️ Neo4j health check returned HTTP $response"
          fi

# Notes:
# ======
#
# 1. Update URL if you deploy to different Render service name
#    Replace "canopy-intelligence-api" with your actual service name
#
# 2. GitHub Actions may delay scheduled workflows by 3-10 minutes during peak times
#    This is normal and doesn't affect functionality
#
# 3. Alternative keep-alive options:
#    - UptimeRobot.com (free, 50 monitors, 5-min intervals, email alerts)
#    - Cron-Job.org (free, every 1 minute, more reliable than GitHub Actions)
#    - Your own cron job (if you have a server)
#
# 4. Render free tier limits:
#    - 750 hours/month (enough for 24/7 with one service)
#    - This workflow doesn't count against your hours
#    - Only actual service runtime counts
#
# 5. Disable this workflow if:
#    - You prefer cold starts to save compute hours
#    - You're using UptimeRobot or similar service
#    - You upgrade to Render paid tier (no sleep mode)
